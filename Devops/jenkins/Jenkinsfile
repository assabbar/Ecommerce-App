pipeline {
    agent none

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 90, unit: 'MINUTES')
    }

    environment {
        // Control flags for each stage
        RUN_BACKEND_UNIT_TESTS = 'true'
        RUN_FRONTEND_UNIT_TESTS = 'false'
        RUN_BACKEND_INTEGRATION_TESTS = 'true'
        RUN_BUILD_DOCKER_IMAGES = 'true'
        RUN_FULL_STACK_TEST = 'true'
    }

    stages {
        stage('Checkout') {
            agent any
            steps {
                script {
                    echo '====== Checking out code from GitHub ======'
                    checkout scm
                }
            }
        }

        stage('Backend Unit Tests') {
            when {
                expression { return env.RUN_BACKEND_UNIT_TESTS == 'true' }
            }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                script {
                    echo '====== Running Backend Unit Tests (No External Dependencies) ======'
                    sh '''
                        cd backend
                        
                        echo "Testing Product Service..."
                        mvn test -pl product-service -q || echo "No unit tests for product-service"
                        
                        echo "Testing API Gateway..."
                        mvn test -pl api-gateway -q || echo "No unit tests for api-gateway"
                        
                        echo "Testing Notification Service..."
                        mvn test -pl notification-service -q || echo "No unit tests for notification-service"
                    '''
                }
            }
        }

        stage('Frontend Unit Tests') {
            when {
                expression { return env.RUN_FRONTEND_UNIT_TESTS == 'true' }
            }
            agent {
                docker {
                    image 'node:20-alpine'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                script {
                    echo '====== Running Frontend Unit Tests (No Backend Dependencies) ======'
                    sh '''
                        cd frontend
                        apk add --no-cache chromium
                        export CHROME_BIN=/usr/bin/chromium-browser
                        npm ci --legacy-peer-deps
                        npm test -- --browsers=ChromiumHeadless --watch=false
                    '''
                }
            }
        }

        stage('Backend Integration Tests with Databases') {
            when {
                expression { return env.RUN_BACKEND_INTEGRATION_TESTS == 'true' }
            }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v /var/run/docker.sock:/var/run/docker.sock --network host'
                }
            }
            steps {
                script {
                    echo '====== Running Backend Integration Tests with MySQL & MongoDB (Testcontainers) ======'
                    sh '''
                        cd backend
                        
                        echo "Starting MySQL & MongoDB with Testcontainers..."
                        echo "Testing Order Service (MySQL + WireMock for Inventory)..."
                        mvn test -pl order-service -q
                        
                        echo "Testing Inventory Service (MySQL)..."
                        mvn test -pl inventory-service -q
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            when {
                expression { return env.RUN_BUILD_DOCKER_IMAGES == 'true' }
            }
            agent {
                docker {
                    image 'docker:latest'
                    args '-v /var/run/docker.sock:/var/run/docker.sock --network host'
                }
            }
            steps {
                script {
                    echo '====== Building All Docker Images ======'
                    sh '''
                        apk add --no-cache docker-compose bash
                        
                        echo "Cleaning up existing containers..."
                        docker rm -f mongodb mysql zookeeper broker schema-registry api-gateway product-service order-service inventory-service notification-service prometheus loki tempo grafana kafka-ui frontend || true
                        docker compose down -v || true
                        
                        echo "Building Docker images..."
                        docker compose build --no-cache
                        
                        echo "Docker images built successfully!"
                        docker images | grep -E "product-service|order-service|inventory-service|notification-service|api-gateway|frontend"
                    '''
                }
            }
        }

        stage('Full Stack Integration Test') {
            when {
                expression { return env.RUN_FULL_STACK_TEST == 'true' }
            }
            agent {
                docker {
                    image 'docker:latest'
                    args '-v /var/run/docker.sock:/var/run/docker.sock --network host'
                }
            }
            steps {
                script {
                    echo '====== Full Stack Integration: Backend + Frontend + Databases ======'
                    sh '''
                        apk add --no-cache curl bash
                        
                        echo "Starting all services with docker-compose..."
                        docker compose up -d
                        
                        echo "Waiting for services to start..."
                        sleep 90
                        
                        echo "=== Health Checks ==="
                        echo "Product Service (8080)..."
                        curl -f http://localhost:8080/actuator/health || exit 1
                        
                        echo "Order Service (8081)..."
                        curl -f http://localhost:8081/actuator/health || exit 1
                        
                        echo "Inventory Service (8082)..."
                        curl -f http://localhost:8082/actuator/health || exit 1
                        
                        echo "Notification Service (8083)..."
                        curl -f http://localhost:8083/actuator/health || exit 1
                        
                        echo "API Gateway (9000)..."
                        curl -f http://localhost:9000/actuator/health || exit 1
                        
                        echo "Frontend (3000)..."
                        curl -f http://localhost:3000/ || exit 1
                        
                        echo "✅ All services are UP and HEALTHY!"
                    '''
                }
            }
        }
    }

    post {
        always {
            node('any') {
                script {
                    echo '====== Cleaning up all containers ======'
                    sh '''
                        docker rm -f mongodb mysql zookeeper broker schema-registry api-gateway product-service order-service inventory-service notification-service prometheus loki tempo grafana kafka-ui frontend || true
                        docker compose down -v || true
                    '''
                }
            }
        }
        success {
            node('any') {
                echo '✅ Pipeline completed successfully!'
            }
        }
        failure {
            node('any') {
                echo '❌ Pipeline failed. Check logs above.'
            }
        }
    }
}