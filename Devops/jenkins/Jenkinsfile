pipeline {
    agent none

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 60, unit: 'MINUTES')
    }

    environment {
        BACKEND_DIR = 'backend'
        FRONTEND_DIR = 'frontend'
        API_GATEWAY_URL = 'http://localhost:9000'
        PRODUCT_SERVICE_URL = 'http://localhost:8080'
        ORDER_SERVICE_URL = 'http://localhost:8081'
        INVENTORY_SERVICE_URL = 'http://localhost:8082'
    }

    stages {
        stage('Checkout') {
            agent any
            steps {
                script {
                    echo '====== Checking out code ======'
                    checkout scm
                }
            }
        }

        stage('Backend Compilation') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                script {
                    echo '====== Backend Compilation & Validation ======'
                    sh '''
                        cd ${BACKEND_DIR}
                        echo "Compiling backend services..."
                        mvn clean compile -q
                        echo "✓ Backend compilation successful!"
                    '''
                }
            }
        }

        stage('Frontend Unit Tests') {
            agent {
                docker {
                    image 'node:20-alpine'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                script {
                    echo '====== Frontend Unit Tests ======'
                    sh '''
                        # Install Chromium for Karma tests
                        apk add --no-cache chromium
                        export CHROME_BIN=/usr/bin/chromium-browser
                        export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
                        
                        cd ${FRONTEND_DIR}
                        npm ci --legacy-peer-deps
                        
                        # Create custom Karma launcher for root
                        cat >> karma.conf.js << 'EOF'

module.exports = function(config) {
  config.set({
    customLaunchers: {
      ChromeHeadlessNoSandbox: {
        base: 'ChromeHeadless',
        flags: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-gpu'
        ]
      }
    }
  });
};
EOF
                        
                        # Run tests with custom launcher
                        npm test -- --watch=false --browsers=ChromeHeadlessNoSandbox
                    '''
                }
            }
        }

        // stage('Build Backend') {
        //     agent {
        //         docker {
        //             image 'maven:3.9-eclipse-temurin-21'
        //             args '-v /var/run/docker.sock:/var/run/docker.sock'
        //         }
        //     }
        //     steps {
        //         script {
        //             echo '====== Building Backend ======'
        //             sh 'cd ${BACKEND_DIR}; mvn clean package -DskipTests -q'
        //         }
        //     }
        // }

        stage('Docker Build & Integration Tests') {
            agent {
                docker {
                    image 'docker:latest'
                    args '-v /var/run/docker.sock:/var/run/docker.sock --network host'
                }
            }
            steps {
                script {
                    echo '====== Docker Build & Integration Tests ======'
                    sh '''
                        apk add --no-cache docker-compose curl bash
                        docker compose build
                        docker compose up -d mongodb mysql zookeeper broker schema-registry
                        sleep 30
                        docker compose up -d
                        sleep 45
                        curl -f ${PRODUCT_SERVICE_URL}/actuator/health || exit 1
                        curl -f ${ORDER_SERVICE_URL}/actuator/health || exit 1
                        curl -f ${INVENTORY_SERVICE_URL}/actuator/health || exit 1
                        curl -f ${API_GATEWAY_URL}/actuator/health || exit 1
                        docker compose down -v
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '✓ Pipeline Success!'
        }
        failure {
            echo '✗ Pipeline Failed!'
        }
    }
}