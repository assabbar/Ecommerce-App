pipeline {
    agent none

    environment {
        // Azure Container Registry
        ACR_NAME = 'acrecomdev12161808'
        ACR_LOGIN_SERVER = "${ACR_NAME}.azurecr.io"
        
        // Docker image version
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // Services to build
        SERVICES = 'product-service order-service inventory-service notification-service api-gateway frontend'
        
        // Enable Docker BuildKit for cache mounts
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
        
        // Control flags
        RUN_BACKEND_TESTS = 'true'
        RUN_FRONTEND_TESTS = 'true'
        RUN_INTEGRATION_TESTS = 'true'
        RUN_BUILD_IMAGES = 'true'
        RUN_PUSH_TO_ACR = 'false'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 180, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            agent any
            steps {
                script {
                    echo '====== Checkout Code from GitHub ======'
                    checkout scm
                    sh 'git rev-parse --short HEAD > .git/commit-id'
                    env.GIT_COMMIT_SHORT = readFile('.git/commit-id').trim()
                    echo "Git commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Backend Unit Tests') {
            when {
                expression {
                    return env.RUN_BACKEND_TESTS == 'true'
                }
            }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v $HOME/.m2:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                script {
                    echo '====== Backend Unit Testing Stage ======'
                    echo 'Running backend unit tests...'
                    
                    dir('backend') {
                        sh '''
                            echo "Compiling all services..."
                            mvn clean compile -DskipTests
                            
                            echo ""
                            echo "Running unit tests for each service..."
                            
                            # Product Service Tests
                            echo "Testing product-service..."
                            mvn test -pl product-service -Dtest=ProductServiceTest -q || true
                            
                            # Notification Service Tests
                            echo "Testing notification-service..."
                            mvn test -pl notification-service -Dtest=NotificationServiceTest -q || true
                            
                            # Inventory Service Tests
                            echo "Testing inventory-service..."
                            mvn test -pl inventory-service -Dtest=InventoryServiceApplicationTests -q || true
                            
                            echo ""
                            echo "✅ Backend unit tests completed!"
                        '''
                    }
                }
            }
        }
        
        stage('Frontend Unit Tests') {
            when {
                expression {
                    return env.RUN_FRONTEND_TESTS == 'true'
                }
            }
            agent {
                docker {
                    image 'node:20-alpine'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                    reuseNode true
                }
            }
            steps {
                script {
                    echo '====== Frontend Unit Testing Stage ======'
                    echo 'Running frontend unit tests...'
                    
                    dir('frontend') {
                        sh '''
                            echo "Installing dependencies..."
                            npm ci --legacy-peer-deps || true
                            
                            echo "Running frontend tests in CI mode..."
                            CI=true npm test -- --watch=false --code-coverage 2>&1 | tail -50 || true
                            
                            echo ""
                            echo "✅ Frontend unit tests completed!"
                        '''
                    }
                }
            }
        }

        stage('Integration Tests') {
            when {
                expression {
                    return env.RUN_INTEGRATION_TESTS == 'true'
                }
            }
            agent any
            steps {
                script {
                    echo '====== Integration Testing Stage ======'
                    echo 'Starting services with Docker Compose and running integration tests...'
                    
                    try {
                        sh '''
                            echo "Starting test environment..."
                            cd Devops/jenkins
                            docker compose -f docker-compose.test.yml up -d --remove-orphans
                            
                            echo "Waiting for services to start (60 seconds)..."
                            sleep 60
                            
                            echo "Service status:"
                            docker compose -f docker-compose.test.yml ps
                            
                            echo ""
                            echo "Checking service health..."
                            docker compose -f docker-compose.test.yml logs --tail=50
                        '''
                        
                        // Run integration tests
                        dir('backend') {
                            sh '''
                                echo "Running integration tests..."
                                mvn test -Dtest=FullStackIntegrationTest -pl order-service || true
                                
                                echo "✅ Integration tests completed!"
                            '''
                        }
                        
                    } catch (Exception e) {
                        echo "⚠️  Integration tests failed: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    } finally {
                        // Cleanup test environment
                        sh '''
                            echo "Cleaning up test environment..."
                            cd Devops/jenkins
                            docker compose -f docker-compose.test.yml down -v || true
                        '''
                    }
                }
            }
        }
        
        stage('Build Docker Images') {
            when {
                expression {
                    return env.RUN_BUILD_IMAGES == 'true'
                }
            }
            agent any
            steps {
                script {
                    echo '====== Build Docker Images Stage ======'
                    echo 'Building all service images with BuildKit cache...'
                    
                    retry(2) {
                        sh '''
                            echo "Building with Docker BuildKit and cache mounts..."
                            echo "DOCKER_BUILDKIT=${DOCKER_BUILDKIT}"
                            
                            # Build all images with BuildKit cache
                            docker compose build --progress=plain
                            
                            echo ""
                            echo "✅ Images built successfully:"
                            docker images | grep malak || true
                        '''
                    }
                }
            }
        }

        stage('Push Images to ACR') {
            when {
                expression {
                    return env.RUN_PUSH_TO_ACR == 'true'
                }
            }
            agent any
            steps {
                script {
                    echo '====== Push Images to Azure Container Registry ======'
                    
                    // Login to Azure ACR
                    withCredentials([azureServicePrincipal('azure-sp-ecom')]) {
                        sh '''
                            echo "Logging in to Azure..."
                            az login --service-principal \
                                --username $AZURE_CLIENT_ID \
                                --password $AZURE_CLIENT_SECRET \
                                --tenant $AZURE_TENANT_ID
                            
                            # Set subscription
                            az account set --subscription $AZURE_SUBSCRIPTION_ID
                            
                            # Login to ACR
                            az acr login --name ${ACR_NAME}
                            echo "✅ Successfully logged in to ACR: ${ACR_LOGIN_SERVER}"
                        '''
                    }
                    
                    // Tag and push images
                    sh '''
                        echo "Tagging and pushing images to ACR..."
                        
                        # Tag and push each service image
                        for service in ${SERVICES}; do
                            echo "Processing ${service}..."
                            
                            # Tag with build number and latest
                            docker tag malak-${service}:latest ${ACR_LOGIN_SERVER}/${service}:${IMAGE_TAG}
                            docker tag malak-${service}:latest ${ACR_LOGIN_SERVER}/${service}:latest
                            
                            # Push both tags
                            echo "Pushing ${service}:${IMAGE_TAG}..."
                            docker push ${ACR_LOGIN_SERVER}/${service}:${IMAGE_TAG}
                            
                            echo "Pushing ${service}:latest..."
                            docker push ${ACR_LOGIN_SERVER}/${service}:latest
                            
                            echo "✅ ${service} pushed successfully!"
                            echo ""
                        done
                        
                        echo "================================================"
                        echo "All images pushed to ACR successfully!"
                        echo "================================================"
                        
                        # Verify images in ACR
                        echo ""
                        echo "Listing images in ACR..."
                        az acr repository list --name ${ACR_NAME} --output table
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '''
            ================================================
            ✅ CI/CD PIPELINE COMPLETED SUCCESSFULLY!
            ================================================
            
            Stages Completed:
              ✓ Code Checkout from GitHub
              ✓ Backend Unit Tests
              ✓ Frontend Unit Tests
              ✓ Integration Tests (docker-compose.test.yml)
              ✓ Docker Images Built
              ✓ Images Pushed to ACR (if enabled)
            
            Next Steps:
              1. Deploy to AKS
              2. Run smoke tests
              3. Promote to production
            ================================================
            '''
        }
        failure {
            echo '''
            ================================================
            ❌ CI/CD PIPELINE FAILED
            ================================================
            
            Check logs above for details.
            ================================================
            '''
        }
        unstable {
            echo '''
            ================================================
            ⚠️  CI/CD PIPELINE COMPLETED WITH WARNINGS
            ================================================
            
            Some tests may have failed but build continued.
            Check logs for details.
            ================================================
            '''
        }
        always {
            node('any') {
                script {
                    // Cleanup Docker resources
                    sh '''
                        echo "Cleaning up Docker resources..."
                        docker system prune -f --volumes || true
                    '''
                }
            }
        }
    }
}
