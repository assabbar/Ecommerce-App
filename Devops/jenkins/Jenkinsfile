pipeline {
    agent any

    environment {
        // Azure Container Registry
        ACR_NAME = 'acrecomdev12161808'
        ACR_LOGIN_SERVER = "${ACR_NAME}.azurecr.io"
        
        // Docker image version
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // Services to build
        SERVICES = 'product-service order-service inventory-service notification-service api-gateway frontend'
        
        // Enable Docker BuildKit for cache mounts
        DOCKER_BUILDKIT = '1'
        COMPOSE_DOCKER_CLI_BUILD = '1'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 180, unit: 'MINUTES')
    }

    parameters {
        booleanParam(
            name: 'SKIP_DOCKER_BUILD',
            defaultValue: false,
            description: 'Skip Docker image build stage (use cached images)'
        )
        booleanParam(
            name: 'SKIP_INTEGRATION_TESTS',
            defaultValue: false,
            description: 'Skip full stack integration tests'
        )
        booleanParam(
            name: 'SKIP_ACR_PUSH',
            defaultValue: false,
            description: 'Skip pushing images to Azure Container Registry'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo '====== Checkout Code from GitHub ======'
                    checkout scm
                    sh 'git rev-parse --short HEAD > .git/commit-id'
                    env.GIT_COMMIT_SHORT = readFile('.git/commit-id').trim()
                    echo "Git commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        stage('Backend Unit Tests') {
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v $HOME/.m2:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                script {
                    echo '====== Running Unit Tests ======'
                    dir('backend') {
                        sh '''
                            echo "Compiling all services..."
                            mvn clean compile -DskipTests
                            
                            echo ""
                            echo "Running unit tests for each service..."
                            
                            # Product Service Tests
                            echo "Testing product-service..."
                            mvn test -pl product-service -Dtest=ProductServiceTest -q || true
                            
                            # Notification Service Tests
                            echo "Testing notification-service..."
                            mvn test -pl notification-service -Dtest=NotificationServiceTest -q || true
                            
                            # Inventory Service Tests
                            echo "Testing inventory-service..."
                            mvn test -pl inventory-service -Dtest=InventoryServiceApplicationTests -q || true
                            
                            echo ""
                            echo "✅ Unit tests completed!"
                        '''
                    }
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Build Docker Images') {
            when {
                expression { !params.SKIP_DOCKER_BUILD }
            }
            steps {
                script {
                    echo '====== Building Docker Images with BuildKit Cache ======'
                    
                    retry(3) {
                        sh '''
                            echo "Building with Docker BuildKit and cache mounts..."
                            echo "DOCKER_BUILDKIT=${DOCKER_BUILDKIT}"
                            
                            # Build all images with BuildKit cache
                            docker compose build --progress=plain
                            
                            echo ""
                            echo "✅ Images built successfully:"
                            docker images | grep malak || true
                        '''
                    }
                }
            }
        }

        stage('Full Stack Integration Tests') {
            when {
                expression { !params.SKIP_INTEGRATION_TESTS }
            }
            steps {
                script {
                    echo '====== Running Full Stack Integration Tests ======'
                    try {
                        // Start test environment
                        sh '''
                            echo "Starting test environment..."
                            cd Devops/jenkins
                            docker compose -f docker-compose.test.yml up -d
                            
                            echo "Waiting for services to stabilize (120 seconds)..."
                            sleep 120
                            
                            echo "Checking service status..."
                            docker compose -f docker-compose.test.yml ps
                        '''
                        
                        // Run integration tests
                        dir('backend') {
                            sh '''
                                echo "Running full stack integration tests..."
                                mvn test -Dtest=FullStackIntegrationTest -pl order-service || true
                            '''
                        }
                        
                        echo "✅ Integration tests stage completed!"
                        
                    } catch (Exception e) {
                        echo "⚠️  Integration tests failed: ${e.message}"
                    } finally {
                        // Cleanup test environment
                        sh '''
                            echo "Cleaning up test environment..."
                            cd Devops/jenkins
                            docker compose -f docker-compose.test.yml down -v || true
                        '''
                    }
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: '**/target/failsafe-reports/*.xml'
                }
            }
        }

        stage('Login to Azure ACR') {
            steps {
                script {
                    echo '====== Logging in to Azure Container Registry ======'
                    withCredentials([azureServicePrincipal('azure-sp-ecom')]) {
                        sh '''
                            # Login to Azure
                            az login --service-principal \
                                --username $AZURE_CLIENT_ID \
                                --password $AZURE_CLIENT_SECRET \
                                --tenant $AZURE_TENANT_ID
                            
                            # Set subscription
                            az account set --subscription $AZURE_SUBSCRIPTION_ID
                            
                            # Login to ACR
                            az acr login --name ${ACR_NAME}
                            
                            echo "✅ Successfully logged in to ACR: ${ACR_LOGIN_SERVER}"
                        '''
                    }
                }
            }
        }

        stage('Tag and Push Images to ACR') {
            when {
                expression { !params.SKIP_ACR_PUSH }
            }
            steps {
                script {
                    echo '====== Tagging and Pushing Images to ACR ======'
                    sh '''
                        # Tag and push each service image
                        for service in ${SERVICES}; do
                            echo "Processing ${service}..."
                            
                            # Tag with build number
                            docker tag malak-${service}:latest ${ACR_LOGIN_SERVER}/${service}:${IMAGE_TAG}
                            docker tag malak-${service}:latest ${ACR_LOGIN_SERVER}/${service}:latest
                            
                            # Push both tags
                            echo "Pushing ${service}:${IMAGE_TAG}..."
                            docker push ${ACR_LOGIN_SERVER}/${service}:${IMAGE_TAG}
                            
                            echo "Pushing ${service}:latest..."
                            docker push ${ACR_LOGIN_SERVER}/${service}:latest
                            
                            echo "✅ ${service} pushed successfully!"
                            echo ""
                        done
                        
                        echo "================================================"
                        echo "All images pushed to ACR successfully!"
                        echo "================================================"
                    '''
                }
            }
        }

        stage('Verify ACR Images') {
            steps {
                script {
                    echo '====== Verifying Images in ACR ======'
                    sh '''
                        echo "Listing images in ACR..."
                        az acr repository list --name ${ACR_NAME} --output table
                        
                        echo ""
                        echo "Showing tags for each repository..."
                        for service in ${SERVICES}; do
                            echo "Tags for ${service}:"
                            az acr repository show-tags --name ${ACR_NAME} --repository ${service} --output table --orderby time_desc | head -5 || true
                        done
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '''
            ================================================
            ✅ CI/CD PIPELINE COMPLETED SUCCESSFULLY!
            ================================================
            
            Stages Completed:
              ✓ Code Checkout from GitHub
              ✓ Backend Unit Tests
              ✓ Docker Images Built
              ✓ Full Stack Integration Tests
              ✓ Images Tagged and Pushed to ACR
              ✓ ACR Images Verified
            
            Next Steps:
              1. Deploy to AKS
              2. Run smoke tests
              3. Promote to production
            ================================================
            '''
        }
        failure {
            echo '''
            ================================================
            ❌ CI/CD PIPELINE FAILED
            ================================================
            
            Check logs above for details.
            ================================================
            '''
        }
        always {
            // Cleanup
            sh '''
                echo "Cleaning up Docker resources..."
                docker system prune -f || true
            '''
        }
    }
}