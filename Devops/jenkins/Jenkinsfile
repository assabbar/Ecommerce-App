pipeline {
    agent none

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 90, unit: 'MINUTES')
    }

    environment {
        // Control flags for each stage
        RUN_BACKEND_COMPILATION = 'true'
        RUN_BUILD_DOCKER_IMAGES = 'true'
        RUN_INTEGRATION_TESTS = 'true'
    }

    stages {
        stage('Checkout') {
            agent any
            steps {
                script {
                    echo '====== Checking out code from GitHub ======'
                    checkout scm
                }
            }
        }

        stage('Backend Compilation & Tests') {
            when {
                expression { return env.RUN_BACKEND_COMPILATION == 'true' }
            }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                script {
                    echo '====== Compiling Backend Services ======'
                    sh '''
                        cd backend
                        echo "Compiling all backend services..."
                        mvn clean compile -DskipTests -q
                        echo "✅ Backend compilation successful!"
                    '''
                }
            }
        }

        stage('Build Docker Images') {
            when {
                expression { return env.RUN_BUILD_DOCKER_IMAGES == 'true' }
            }
            agent {
                docker {
                    image 'docker:latest'
                    args '-v /var/run/docker.sock:/var/run/docker.sock --network host'
                }
            }
            steps {
                script {
                    echo '====== Building All Docker Images ======'
                    sh '''
                        apk add --no-cache docker-compose bash
                        
                        echo "Cleaning up existing containers..."
                        docker rm -f mongodb mysql zookeeper broker schema-registry api-gateway product-service order-service inventory-service notification-service prometheus loki tempo grafana kafka-ui frontend || true
                        docker compose down -v || true
                        
                        echo "Building Docker images..."
                        docker compose build --no-cache
                        
                        echo "Docker images built successfully!"
                        docker images | grep -E "product-service|order-service|inventory-service|notification-service|api-gateway|frontend"
                    '''
                }
            }
        }

        stage('Integration Tests - Full Stack') {
            when {
                expression { return env.RUN_INTEGRATION_TESTS == 'true' }
            }
            agent {
                docker {
                    image 'docker:latest'
                    args '-v /var/run/docker.sock:/var/run/docker.sock --network host'
                }
            }
            steps {
                script {
                    echo '====== Full Stack Integration: Backend + Frontend + Databases ======'
                    sh '''
                        apk add --no-cache curl bash
                        
                        echo "Starting all services with docker-compose..."
                        docker compose up -d
                        
                        echo "Waiting for infrastructure (MongoDB, MySQL, Kafka)..."
                        sleep 45
                        
                        echo "Waiting for microservices to start..."
                        sleep 60
                        
                        echo "=== Service Health Checks ==="
                        
                        echo "✓ Checking Product Service (8080)..."
                        curl -f http://localhost:8080/actuator/health || exit 1
                        
                        echo "✓ Checking Order Service (8081)..."
                        curl -f http://localhost:8081/actuator/health || exit 1
                        
                        echo "✓ Checking Inventory Service (8082)..."
                        curl -f http://localhost:8082/actuator/health || exit 1
                        
                        echo "✓ Checking Notification Service (8083)..."
                        curl -f http://localhost:8083/actuator/health || exit 1
                        
                        echo "✓ Checking API Gateway (9000)..."
                        curl -f http://localhost:9000/actuator/health || exit 1
                        
                        echo "✓ Checking Frontend (3000)..."
                        curl -f http://localhost:3000/ || exit 1
                        
                        echo ""
                        echo "================================================"
                        echo "✅ ALL SERVICES ARE UP AND HEALTHY!"
                        echo "================================================"
                    '''
                }
            }
        }
    }

    post {
        always {
            node('any') {
                script {
                    echo '====== Cleaning up all containers ======'
                    sh '''
                        docker rm -f mongodb mysql zookeeper broker schema-registry api-gateway product-service order-service inventory-service notification-service prometheus loki tempo grafana kafka-ui frontend || true
                        docker compose down -v || true
                    '''
                }
            }
        }
        success {
            node('any') {
                echo '✅ Pipeline completed successfully!'
            }
        }
        failure {
            node('any') {
                echo '❌ Pipeline failed. Check logs above.'
            }
        }
    }
}